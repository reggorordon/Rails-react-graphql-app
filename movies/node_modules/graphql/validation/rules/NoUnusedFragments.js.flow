/**
<<<<<<< HEAD
 * Copyright (c) Facebook, Inc. and its affiliates.
=======
 * Copyright (c) 2015-present, Facebook, Inc.
>>>>>>> b22d4f639358533e1bbd355b77d7a3342c6a63e8
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @flow strict
 */

<<<<<<< HEAD
import type { ASTValidationContext } from '../ValidationContext';
=======
import type { ValidationContext } from '../ValidationContext';
>>>>>>> b22d4f639358533e1bbd355b77d7a3342c6a63e8
import { GraphQLError } from '../../error/GraphQLError';
import type { ASTVisitor } from '../../language/visitor';

export function unusedFragMessage(fragName: string): string {
  return `Fragment "${fragName}" is never used.`;
}

/**
 * No unused fragments
 *
 * A GraphQL document is only valid if all fragment definitions are spread
 * within operations, or spread within other fragments spread within operations.
 */
<<<<<<< HEAD
export function NoUnusedFragments(context: ASTValidationContext): ASTVisitor {
=======
export function NoUnusedFragments(context: ValidationContext): ASTVisitor {
>>>>>>> b22d4f639358533e1bbd355b77d7a3342c6a63e8
  const operationDefs = [];
  const fragmentDefs = [];

  return {
    OperationDefinition(node) {
      operationDefs.push(node);
      return false;
    },
    FragmentDefinition(node) {
      fragmentDefs.push(node);
      return false;
    },
    Document: {
      leave() {
        const fragmentNameUsed = Object.create(null);
        for (const operation of operationDefs) {
          for (const fragment of context.getRecursivelyReferencedFragments(
            operation,
          )) {
            fragmentNameUsed[fragment.name.value] = true;
          }
        }

        for (const fragmentDef of fragmentDefs) {
          const fragName = fragmentDef.name.value;
          if (fragmentNameUsed[fragName] !== true) {
            context.reportError(
<<<<<<< HEAD
              new GraphQLError(unusedFragMessage(fragName), fragmentDef),
=======
              new GraphQLError(unusedFragMessage(fragName), [fragmentDef]),
>>>>>>> b22d4f639358533e1bbd355b77d7a3342c6a63e8
            );
          }
        }
      },
    },
  };
}
